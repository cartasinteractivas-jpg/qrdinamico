<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR Dinámico - Registro Elegante</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { width: 100%; height: 100%; font-family: 'Georgia', serif; }
    .app-wrapper { width: 100%; min-height: 100vh; background: #0a0a0a; color: #ffffff; overflow-x: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
    .form-card { background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 8px; padding: 40px; max-width: 500px; width: 100%; transition: all 0.3s ease; position: relative; overflow: hidden; text-align: center; box-shadow: 0 10px 30px rgba(212, 175, 55, 0.1 ); }
    .form-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: linear-gradient(90deg, transparent 0%, #d4af37 50%, transparent 100%); transform: translateX(-100%); transition: transform 0.6s ease; }
    .form-card:hover::before { transform: translateX(100%); }
    .main-title { font-size: 48px; font-weight: 300; letter-spacing: 5px; text-transform: uppercase; margin-bottom: 10px; background: linear-gradient(135deg, #ffffff 0%, #d4af37 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; position: relative; z-index: 1; }
    .subtitle { font-size: 18px; font-weight: 300; letter-spacing: 2px; color: #ffffff; opacity: 0.9; margin-bottom: 20px; }
    .precio { font-size: 24px; color: #d4af37; margin: 20px 0; font-weight: bold; letter-spacing: 1px; }
    input { width: 100%; padding: 15px; margin: 12px 0; border-radius: 4px; font-size: 16px; border: 1px solid #2a2a2a; background: #0a0a0a; color: #ffffff; transition: border-color 0.3s; }
    input:focus { outline: none; border-color: #d4af37; }
    input::placeholder { color: #888888; }
    .btn-primary { display: block; width: 100%; padding: 18px 50px; font-size: 16px; font-weight: 400; letter-spacing: 3px; text-transform: uppercase; color: #0a0a0a; background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%); border: none; border-radius: 4px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3); font-family: 'Georgia', serif; margin-top: 25px; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212, 175, 55, 0.5); background: linear-gradient(135deg, #f4d03f 0%, #d4af37 100%); }
    .pago-info { background: #0a0a0a; border: 1px solid #2a2a2a; padding: 20px; border-radius: 4px; margin: 25px 0; }
    .pago-info h3 { color: #d4af37; font-size: 28px; margin: 10px 0; letter-spacing: 1px; }
    .pago-info p { color: #cccccc; }
    #mensaje { margin-top:20px; padding:15px; border-radius:4px; font-weight:bold; }
    .exito { background:#2ecc71; color:#0a0a0a; }
    .error { background:#e74c3c; color:#ffffff; }
    .hidden { display:none !important; }
    #intro { position:fixed; inset:0; z-index:9999; background: #0a0a0a; }
    #intro video { width:100vw; height:100vh; object-fit:cover; }
    .overlay { position:absolute; inset:0; background:rgba(0, 0, 0, 0.7); }
    .intro-content { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; z-index:2; width:90%; }
    .intro-content h1 { font-size: 64px; font-weight: 300; letter-spacing: 8px; text-transform: uppercase; margin-bottom: 20px; background: linear-gradient(135deg, #ffffff 0%, #d4af37 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .intro-content p { font-size: 20px; font-weight: 300; letter-spacing: 3px; color: #ffffff; opacity: 0.9; }
    .intro-content .btn-primary { margin-top: 40px; }
    @media (max-width: 768px) { 
      .main-title { font-size: 36px; letter-spacing: 4px; } 
      .subtitle { font-size: 16px; letter-spacing: 2px; } 
      .form-card { padding: 30px; } 
      .intro-content h1 { font-size: 36px; letter-spacing: 4px; } 
      .intro-content p { font-size: 16px; letter-spacing: 2px; } 
    }
  </style>
</head>
<body>
  <div id="intro">
    <video src="https://github.com/cartasinteractivas-jpg/qrmanager/raw/main/qrdinamicopresentacion.mp4" autoplay muted loop playsinline></video>
    <div class="overlay"></div>
    <div class="intro-content">
      <h1>QR Dinámico Inteligente</h1>
      <p>Cambia el destino de tu QR cuando quieras</p>
      <!-- El botón vuelve a estar dentro de intro-content para que sea visible -->
      <button id="skipBtn" class="btn-primary">Saltar video</button>
    </div>
  </div>

  <div id="formulario" class="app-wrapper hidden">
    <div class="form-card">
      <h2 class="main-title">¡Activa tu QR Dinámico ya!</h2>
      <p class="subtitle">Completa el formulario para empezar</p>
      <p class="precio">Solo S/ 10 soles al mes</p>
      <form id="registroForm">
        <input type="text" id="usuario" placeholder="Usuario (para ingresar al panel  )" required />
        <input type="text" id="clave" placeholder="Contraseña segura" required />
        <input type="text" id="url_activo" placeholder="URL inicial (ej: mipagina.com)" required />
        <input type="tel" id="telefono" placeholder="Tu número de celular (para enviarte el QR)" required />
        <div class="pago-info" style="background: transparent; border-color: #d4af37;">
          <h3 style="font-size: 22px;">Miles de URLs en la misma impresión QR</h3>
          <p style="font-size: 16px; margin-top: 15px; color: #cccccc;">
            Ahorra en impresiones y maximiza tu alcance. Cambia la dirección de tu QR a una nueva oferta, menú, video o página web cuando quieras, sin reimprimir nada.
          </p>
        </div>
        <button type="submit" class="btn-primary">SOLICITAR MI QR AHORA</button>
      </form>
      <div id="mensaje"></div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://flcxihzwyexgigavztce.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsY3hpaHp3eWV4Z2lnYXZ6dGNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyODI0MzAsImV4cCI6MjA3OTg1ODQzMH0.7Ur3LcihnR6wIEM7QjFxNIe4ci2TmIVVt8ZcvekFSqA';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY );

    // --- LÓGICA DE TRANSICIÓN SIMPLIFICADA Y CORREGIDA ---

    // Función única para pasar del intro al formulario
    function mostrarFormulario() {
      // Cancela el temporizador automático si el usuario hace clic primero
      clearTimeout(timeoutId);
      document.getElementById('intro').classList.add('hidden');
      document.getElementById('formulario').classList.remove('hidden');
    }

    // Asigna el evento de clic al botón "Saltar video"
    document.getElementById('skipBtn').addEventListener('click', mostrarFormulario);

    // Inicia el temporizador para la transición automática después de 8 segundos
    const timeoutId = setTimeout(mostrarFormulario, 8000);

    // --- FIN DE LA LÓGICA DE TRANSICIÓN ---


    // Resto del código (registro, etc.) sin cambios
    async function generarNuevoId() {
      const { data, error } = await supabase.from('qrs').select('id').order('id', { ascending: false }).limit(1);
      if (error || !data || data.length === 0) return '00001';
      const ultimo = parseInt(data[0].id);
      return (ultimo + 1).toString().padStart(5, '0');
    }

    function formatarUrlInteligente(url) {
        if (!url || url.trim() === '') return '';
        url = url.trim();
        if (!/^https?:\/\//i.test(url )) { url = 'https://' + url; }
        let urlSinProtocolo = url.substring(url.indexOf('//' ) + 2);
        if (!urlSinProtocolo.startsWith('www.') && urlSinProtocolo.split('.').length === 2 && urlSinProtocolo.split('.')[0].length > 0) { 
            url = 'https://www.' + urlSinProtocolo; 
        }
        if (!/\.[a-z]{2,6}(\/.* )?$/i.test(url)) { url += '.com'; }
        return url;
    }

    function mostrarMensaje(texto, tipo) {
      const msg = document.getElementById('mensaje');
      msg.innerHTML = texto;
      msg.className = 'mensaje ' + tipo;
    }

    document.getElementById('registroForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        btn.disabled = true;
        btn.textContent = 'Procesando...';

        const usuario = document.getElementById('usuario').value.trim();
        const clave = document.getElementById('clave').value.trim();
        const urlOriginal = document.getElementById('url_activo').value.trim();
        const urlFormateada = formatarUrlInteligente(urlOriginal);
        const telefono = document.getElementById('telefono').value.trim();

        try {
            const { data: existingCredentials, error: checkError } = await supabase
                .from('qrs').select('id').eq('usuario', usuario).eq('clave', clave).single();
            if (existingCredentials) {
                mostrarMensaje('Ese nombre de usuario y clave ya han sido tomados. Por favor, elige una combinación diferente.', 'error');
                btn.disabled = false;
                btn.textContent = 'SOLICITAR MI QR AHORA';
                return;
            }
            if (checkError && checkError.code !== 'PGRST116') throw checkError;
        } catch (error) {
            console.error("Error al verificar credenciales:", error);
            mostrarMensaje('Hubo un error al verificar los datos. Inténtalo de nuevo.', 'error');
            btn.disabled = false;
            btn.textContent = 'SOLICITAR MI QR AHORA';
            return;
        }

        if (!urlFormateada) {
            alert('Por favor, ingresa una URL válida.');
            btn.disabled = false;
            btn.textContent = 'SOLICITAR MI QR AHORA';
            return;
        }

        const nuevoId = await generarNuevoId();
        const hoy = new Date().toISOString().split('T')[0];
        const nuevoCliente = {
            id: nuevoId,
            usuario,
            clave,
            url_activo: urlFormateada,
            telefono,
            pago: false,
            fecha_pago: hoy
        };

        const { error: insertError } = await supabase.from('qrs').insert(nuevoCliente);
        if (insertError) {
            console.error("Error al registrar en la base de datos:", insertError);
            mostrarMensaje('Error al registrar. Intenta otra vez o contáctanos.', 'error');
            btn.disabled = false;
            btn.textContent = 'SOLICITAR MI QR AHORA';
            return;
        }
       
        try {
            const functionUrl = 'https://flcxihzwyexgigavztce.supabase.co/functions/v1/send-email';
            const datosParaCorreo = { id: nuevoCliente.id, usuario: nuevoCliente.usuario, clave: nuevoCliente.clave, url_activo: nuevoCliente.url_activo, telefono: nuevoCliente.telefono, fecha_solicitud: nuevoCliente.fecha_pago };
            const response = await fetch(functionUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` },
                body: JSON.stringify(datosParaCorreo )
            });
            if (!response.ok) console.error('Error desde la Edge Function:', await response.text());
            else console.log('Respuesta de la función de correo:', (await response.json()).message);
        } catch (fetchError) {
            console.error('Error de red o CORS al invocar la función:', fetchError);
        }

        mostrarMensaje(`
            ¡Perfecto! Registro completado.
              
  

            <strong>Tu ID es: ${nuevoId}</strong>
              
  

            Serás redirigido a WhatsApp para completar tu solicitud...
        `, 'exito');
       
        const mensajeWhatsApp = `Me he inscrito en obtener mi QR Dinamico, (Usuario: ${nuevoCliente.usuario}, Teléfono: ${nuevoCliente.telefono}, URL: ${nuevoCliente.url_activo}, Código: ${nuevoCliente.id})`;
        const mensajeCodificado = encodeURIComponent(mensajeWhatsApp);
        const numeroWhatsApp = '51967188120';
        const urlWhatsApp = `https://wa.me/${numeroWhatsApp}?text=${mensajeCodificado}`;
        setTimeout(( ) => {
            window.location.href = urlWhatsApp;
        }, 3000);
    });
  </script>
</body>
</html>
