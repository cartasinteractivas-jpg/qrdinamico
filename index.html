<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR Dinámico - Registro</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',sans-serif; }
    body { background:#000; color:white; overflow-x:hidden; }

    /* VIDEO INTRO */
    #intro { position:fixed; inset:0; z-index:9999; }
    #intro video { width:100vw; height:100vh; object-fit:cover; }
    .overlay { position:absolute; inset:0; background:linear-gradient(135deg, rgba(90,0,255,0.85), rgba(147,0,255,0.7)); }
    .intro-content { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; z-index:2; width:90%; }
    .intro-content h1 { font-size:3.5rem; margin-bottom:1rem; text-shadow:0 0 20px rgba(0,0,0,0.8); }
    .btn-primary { background:linear-gradient(45deg,#9D00FF,#D500FF); border:none; padding:14px 32px; font-size:1.2rem; color:white; border-radius:50px; cursor:pointer; margin-top:2rem; box-shadow:0 10px 30px rgba(157,0,255,0.4); transition:all .3s; }
    .btn-primary:hover { transform:translateY(-5px); box-shadow:0 15px 40px rgba(157,0,255,0.6); }

    /* FORMULARIO */
    #formulario { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px; background:linear-gradient(135deg,#1a0033,#000); }
    .form-card { background:rgba(255,255,255,0.05); backdrop-filter:blur(10px); padding:40px; border-radius:20px; max-width:500px; width:100%; border:1px solid rgba(157,0,255,0.3); text-align:center; }
    .form-card h2 { font-size:2.5rem; margin-bottom:10px; background:linear-gradient(45deg,#9D00FF,#FF00FF); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .precio { font-size:1.8rem; color:#00ffea; margin:20px 0; font-weight:bold; }
    input, button { width:100%; padding:15px; margin:12px 0; border-radius:12px; font-size:1rem; border:none; }
    input { background:rgba(255,255,255,0.1); border:1px solid rgba(157,0,255,0.5); color:white; }
    input::placeholder { color:#ccc; }
    .pago-info { background:rgba(157,0,255,0.15); padding:20px; border-radius:15px; margin:25px 0; }
    .pago-info h3 { color:#9D00FF; font-size:1.9rem; margin:10px 0; }
    #mensaje { margin-top:20px; padding:15px; border-radius:10px; font-weight:bold; }
    .exito { background:#00b894; }
    .error { background:#e74c3c; }
    .hidden { display:none !important; }
  </style>
</head>
<body>

  <!-- VIDEO INTRO -->
  <div id="intro" class="intro">
    <video src="https://github.com/cartasinteractivas-jpg/qrmanager/raw/main/qrdinamicopresentacion.mp4" autoplay muted loop playsinline></video>
    <div class="overlay"></div>
    <div class="intro-content">
      <h1>QR Dinámico Inteligente</h1>
      <p>Cambia el destino de tu QR cuando quieras</p>
      <button id="skipBtn" class="btn-primary">Saltar video</button>
    </div>
  </div>

  <!-- FORMULARIO -->
  <div id="formulario" class="hidden">
    <div class="form-card">
      <h2>¡Activa tu QR Dinámico ya!</h2>
      <p class="precio">Solo S/ 10 soles al mes</p>

      <form id="registroForm">
        <input type="text" id="usuario" placeholder="Usuario (para ingresar al panel)" required />
        <input type="password" id="clave" placeholder="Contraseña segura" required />
        <input type="url" id="url_activo" placeholder="URL inicial[](https://...)" required />

        <div class="pago-info">
          <p>Pago mensual por:</p>
          <h3>YAPE 967 188 120</h3>
          <label style="display:flex; align-items:center; justify-content:center; margin-top:15px; font-size:1.1rem;">
            <input type="checkbox" id="pago" required style="width:auto; margin-right:10px; transform:scale(1.5);" />
            Ya hice el pago de S/10 por Yape
          </label>
        </div>

        <button type="submit" class="btn-primary">ACTIVAR MI QR AHORA</button>
      </form>

      <div id="mensaje"></div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://flcxihzwyexgigavztce.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsY3hpaHp3eWV4Z2lnYXZ6dGNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyODI0MzAsImV4cCI6MjA3OTg1ODQzMH0.7Ur3LcihnR6wIEM7QjFxNIe4ci2TmIVVt8ZcvekFSqA';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    document.getElementById('skipBtn').addEventListener('click', () => {
      document.getElementById('intro').classList.add('hidden');
      document.getElementById('formulario').classList.remove('hidden');
    });

    async function generarNuevoId() {
      const { data, error } = await supabase.from('qrs').select('id').order('id', { ascending: false }).limit(1);
      if (error || !data || data.length === 0) return '00001';
      const ultimo = parseInt(data[0].id);
      return (ultimo + 1).toString().padStart(5, '0');
    }

    document.getElementById('registroForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('button');
      btn.disabled = true;
      btn.textContent = 'Procesando...';

      const usuario = document.getElementById('usuario').value.trim();
      const clave = document.getElementById('clave').value;
      const url_activo = document.getElementById('url_activo').value.trim();
      const pagoConfirmado = document.getElementById('pago').checked;

      if (!pagoConfirmado) {
        mostrarMensaje('Confirma que ya realizaste el pago de S/10 por Yape', 'error');
        btn.disabled = false;
        btn.textContent = 'ACTIVAR MI QR AHORA';
        return;
      }

      const nuevoId = await generarNuevoId();
      const hoy = new Date().toISOString().split('T')[0];

      const { error } = await supabase.from('qrs').insert({
        id: nuevoId,
        usuario,
        clave,
        url_activo,
        pago: true,
        fecha_pago: hoy
      });

      if (error) {
        console.error(error);
        mostrarMensaje('Error al registrar. Intenta otra vez o contáctanos.', 'error');
      } else {
        mostrarMensaje(`
          ¡Perfecto! Tu QR está ACTIVADO<br><br>
          <strong>ID: ${nuevoId}</strong><br><br>
          Te enviamos el panel y tu QR por WhatsApp en minutos
        `, 'exito');
        document.getElementById('registroForm').reset();
      }
      btn.disabled = false;
      btn.textContent = 'ACTIVAR MI QR AHORA';
    });

    function mostrarMensaje(texto, tipo) {
      const msg = document.getElementById('mensaje');
      msg.innerHTML = texto;
      msg.className = 'mensaje ' + tipo;
    }

    setTimeout(() => {
      if (!document.getElementById('intro').classList.contains('hidden')) {
        document.getElementById('skipBtn').click();
      }
    }, 30000);
  </script>
</body>
</html>
