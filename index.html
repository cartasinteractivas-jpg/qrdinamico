<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Dinámico - Registro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    
    <!-- Este script se carga primero -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
    /* --- (Todo tu CSS va aquí, no necesita cambios ) --- */
    :root {
        --color-gold: #D4AF37;
        --color-dark: #1a1a1a;
        --color-light: #f4f4f4;
        --color-marble: #ffffff;
        --font-serif: 'Playfair Display', serif;
        --font-sans: 'Roboto', sans-serif;
    }
    body {
        margin: 0;
        font-family: var(--font-sans);
        background: #e9e9e9;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
    }
    .mobile-container {
        width: 390px;
        height: 844px;
        position: relative;
        overflow: hidden;
        border-radius: 45px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        background-color: var(--color-marble);
        border: 10px solid #111;
    }
    #splash-screen {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        z-index: 100;
        display: flex;
        flex-direction: column;
        transition: opacity 0.8s ease-out;
    }
    #splash-video-container {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        overflow: hidden;
    }
    #splash-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        filter: brightness(0.5);
    }
    .splash-content {
        position: relative;
        z-index: 2;
        color: white;
        text-align: center;
        padding: 40px 30px;
        margin-top: 80px;
        text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    .splash-content h1 {
        font-family: var(--font-serif);
        font-size: 48px;
        margin-bottom: 15px;
    }
    .splash-content p {
        font-size: 16px;
        line-height: 1.6;
        font-weight: 300;
        max-width: 300px;
        margin: 0 auto 40px auto;
    }
    .splash-button {
        background-color: var(--color-gold);
        color: var(--color-dark);
        border: none;
        border-radius: 50px;
        padding: 15px 40px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .splash-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
    }
    #form-screen {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        z-index: 99;
        background: linear-gradient(180deg, #fdfbfb 0%, #ebedee 100%);
        padding: 60px 30px 30px 30px;
        display: flex;
        flex-direction: column;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.8s ease-in;
    }
    #form-screen.visible {
        opacity: 1;
        pointer-events: auto;
    }
    #form-screen h2 {
        font-family: var(--font-serif);
        font-size: 36px;
        color: var(--color-dark);
        text-align: center;
        margin-bottom: 30px;
    }
    .form-group {
        margin-bottom: 20px;
        position: relative;
    }
    .form-group label {
        display: block;
        font-size: 14px;
        color: #555;
        margin-bottom: 8px;
        font-weight: bold;
    }
    .form-group input, .form-group select {
        width: 100%;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 16px;
        font-family: var(--font-sans);
        box-sizing: border-box;
        background-color: #fff;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-group input:focus, .form-group select:focus {
        outline: none;
        border-color: var(--color-gold);
        box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
    }
    .payment-group {
        display: flex;
        align-items: center;
        gap: 15px;
        background-color: #fff;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #ccc;
    }
    .payment-group label {
        margin: 0;
        flex-grow: 1;
    }
    .submit-button {
        width: 100%;
        background: linear-gradient(45deg, var(--color-dark), #333);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 18px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        margin-top: 20px;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .submit-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }
    #form-message {
        text-align: center;
        margin-top: 20px;
        font-weight: bold;
    }
</style>
</head>
<body>

<div class="mobile-container">
    <div id="splash-screen">
        <div id="splash-video-container">
            <video id="splash-video" autoplay muted loop playsinline>
                <source src="https://github.com/cartasinteractivas-jpg/qrmanager/blob/main/qrdinamicopresentacion.mp4?raw=true" type="video/mp4">
            </video>
        </div>
        <div class="splash-content">
            <h1>QR Dinámico</h1>
            <p>Crea y gestiona tus códigos QR de forma inteligente. Cambia su destino, programa URLs y lleva tus campañas al siguiente nivel.</p>
            <button id="skip-button" class="splash-button">Empezar Ahora</button>
        </div>
    </div>
    <div id="form-screen">
        <h2>Crear Cuenta</h2>
        <form id="registration-form">
            <div class="form-group">
                <label for="usuario">Nombre de Usuario</label>
                <input type="text" id="usuario" required>
            </div>
            <div class="form-group">
                <label for="clave">Clave</label>
                <input type="password" id="clave" required>
            </div>
            <div class="form-group">
                <label for="url-activo">URL de Destino Inicial</label>
                <input type="url" id="url-activo" placeholder="https://ejemplo.com" required>
            </div>
            <div class="form-group">
                <div class="payment-group">
                    <label for="pago">¿Realizó el pago inicial?</label>
                    <select id="pago">
                        <option value="false" selected>No</option>
                        <option value="true">Sí</option>
                    </select>
                </div>
            </div>
            <button type="submit" class="submit-button">Inscribirse</button>
        </form>
        <p id="form-message"></p>
    </div>
</div>

<script>
    // --- INICIO DEL CÓDIGO JAVASCRIPT ---

    // ¡¡¡LA SOLUCIÓN ESTÁ AQUÍ!!!
    // Envolvemos TODO el código en este evento para asegurar que se ejecuta
    // solo cuando la página y todas sus librerías han cargado.
    document.addEventListener('DOMContentLoaded', ( ) => {

        // 1. Configuración de Supabase (AHORA DENTRO DEL EVENTO)
        const supabaseUrl = 'URL_DE_TU_PROYECTO_SUPABASE'; // <-- REEMPLAZAR
        const supabaseKey = 'TU_SUPABASE_ANON_KEY';      // <-- REEMPLAZAR
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // 2. Lógica de la Interfaz
        const skipButton = document.getElementById('skip-button'); 
        const splashScreen = document.getElementById('splash-screen');
        const formScreen = document.getElementById('form-screen');
        const registrationForm = document.getElementById('registration-form');

        // El listener del botón "Empezar Ahora"
        skipButton.addEventListener('click', () => {
            splashScreen.style.opacity = '0';
            formScreen.classList.add('visible');
            setTimeout(() => {
                splashScreen.style.display = 'none';
            }, 800);
        });

        // El listener del formulario
        registrationForm.addEventListener('submit', (event) => {
            event.preventDefault(); // Prevenimos el envío por defecto
            handleRegistration();   // Llamamos a nuestra función de registro
        });

        // 3. Función para manejar el registro
        async function handleRegistration() {
            const formMessage = document.getElementById('form-message');
            formMessage.textContent = 'Procesando...';
            formMessage.style.color = 'var(--color-dark)';

            let nextId;
            try {
                const { data: lastRecord, error: idError } = await supabase
                    .from('qrs')
                    .select('id')
                    .order('id', { ascending: false })
                    .limit(1)
                    .single();

                if (idError && idError.code !== 'PGRST116') {
                    throw idError;
                }

                if (lastRecord) {
                    const lastIdNumber = parseInt(lastRecord.id, 10);
                    nextId = lastIdNumber + 1;
                } else {
                    nextId = 1;
                }
                nextId = String(nextId).padStart(5, '0');

            } catch (error) {
                console.error('Error al generar el ID:', error.message);
                formMessage.textContent = 'Error crítico al generar ID. Intente de nuevo.';
                formMessage.style.color = 'red';
                return;
            }

            const usuario = document.getElementById('usuario').value;
            const clave = document.getElementById('clave').value;
            const urlActivo = document.getElementById('url-activo').value;
            const pago = document.getElementById('pago').value === 'true';

            const newRecord = {
                id: nextId,
                usuario: usuario,
                clave: clave,
                url_activo: urlActivo,
                pago: pago,
                fecha_pago: pago ? new Date().toISOString().split('T')[0] : null
            };

            try {
                const { error: insertError } = await supabase
                    .from('qrs')
                    .insert(newRecord);

                if (insertError) {
                    throw insertError;
                }

                formMessage.textContent = `¡Registro exitoso! Tu ID de QR es: ${nextId}`;
                formMessage.style.color = 'green';
                registrationForm.reset();

            } catch (error) {
                console.error('Error al registrar:', error.message);
                if (error.code === '23505') {
                     formMessage.textContent = 'Error: El ID generado ya existe. Por favor, intente de nuevo.';
                } else {
                     formMessage.textContent = 'Error al guardar el registro. Verifique los datos.';
                }
                formMessage.style.color = 'red';
            }
        }
    });
</script>

</body>
</html>
